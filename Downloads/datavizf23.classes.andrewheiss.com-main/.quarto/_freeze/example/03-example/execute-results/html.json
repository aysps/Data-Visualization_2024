{
  "hash": "d04d1c9db89625f039a340c5313dcb65",
  "result": {
    "markdown": "---\ntitle: \"Mapping data to graphics\"\ndate: \"2023-09-04\"\ndate_end: \"2023-09-08\"\n---\n\n\nFor this example, I'm going to use real world data to demonstrate the typical process for loading data, cleaning it up a bit, and mapping specific columns of the data onto the parts of a graph using the grammar of graphics and `ggplot()`. \n\nThe data I'll use comes from the BBC's corporate charity, [BBC Children in Need](https://www.bbcchildreninneed.co.uk/), which makes grants to smaller UK nonprofit organizations that work on issues related to childhood poverty. An organization in the UK named [360Giving](https://www.threesixtygiving.org/) helps nonprofits and foundations publish data about their grant giving activities in an open and standardized way, and (as of May 2020) [they list data from 126 different charities](http://data.threesixtygiving.org/), including BBC Children in Need.\n\nIf you want to follow along with this example (highly recommended!), you can download the data directly from [360Giving](http://data.threesixtygiving.org/) or by using this link:\n\n- [{{< fa file-excel >}} `360-giving-data.xlsx`](/files/data/external_data/360-giving-data.xlsx)\n\n\n## Live coding example\n\n::: {.callout-warning}\nI got carried away with this because I wanted to make it as comprehensive and detailed as possible, so it starts off with nothing and walks through the process of downloading data, creating a new project, and getting everything started. As such, it is ridiculously long (1 hour ðŸ˜± ðŸ˜±). Remember that there's no requirement that you watch these thingsâ€”they're simply for your reference so you can see what doing this R stuff looks like in real time. The content all below the video is roughly the same (more polished even).\n\nThat said, it *is* a useful demonstration of how to get everything started and what it looks like to do an entire analysis, so there is value in it. Watch just the first part, or watch it on 2x or something.\n\nAnd I *promise* future examples will not be this long!\n:::\n\n<div class=\"ratio ratio-16x9\">\n<iframe src=\"https://www.youtube.com/embed/2N04T-3kZfw\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen=\"\" frameborder=\"0\"></iframe>\n</div>\n\n\n::: {.callout-important}\n### Slight differences from the video\n\nThis is a slightly cleaned up version of the code from the video.\n:::\n\n\n\n\n\n## Load and clean data\n\nFirst, we need to load a few libraries: {tidyverse} (as always) and {readxl} for reading Excel files:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Load libraries\nlibrary(tidyverse)  # For ggplot, dplyr, and friends\nlibrary(readxl)     # For reading Excel files\n```\n:::\n\n\nWe'll then load the original Excel file. I placed this file in a folder named `data` in my RStudio Project folder for this example. I like to read original data into an object named `whatever_raw` just in case it takes a long time to load (that way I don't have to keep reloading it every time I add a new column or do anything else with it). It's also good practice to keep a pristine, untouched copy of your data. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Load the original Excel file\nbbc_raw <- read_excel(\"data/360-giving-data.xlsx\")\n```\n:::\n\n\n\n\nThere may be some errors reading the fileâ€”you can ignore those in this case.\n\nNext we'll add a couple columns and clean up the data a little. In the video I did this non-linearlyâ€”I came back to the top of the document to add columns when I needed them and then reran the chunk to create the data. \n\nWe'll extract the year from the Award Date column, rename some of the longer-named columns, and make a new column that shows the duration of grants. We'll also get rid of 2015 since there are so few observations then.\n\nNote the strange use of `` ` ``s around column names like `` `Award Date` ``. This is because R technically doesn't allow special characters like spaces in column names. If there are spaces, you have to wrap the column names in backticks. Because typing backticks all the time gets tedious, we'll use `rename()` to rename some of the columns: \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbc <- bbc_raw %>% \n  # Extract the year from the award date\n  mutate(grant_year = year(`Award Date`)) %>% \n  # Rename some columns\n  rename(grant_amount = `Amount Awarded`,\n         grant_program = `Grant Programme:Title`,\n         grant_duration = `Planned Dates:Duration (months)`) %>% \n  # Make a new text-based version of the duration column, recoding months\n  # between 12-23, 23-35, and 36+. The case_when() function here lets us use\n  # multiple if/else conditions at the same time.\n  mutate(grant_duration_text = case_when(\n    grant_duration >= 12 & grant_duration < 24 ~ \"1 year\",\n    grant_duration >= 24 & grant_duration < 36 ~ \"2 years\",\n    grant_duration >= 36 ~ \"3 years\"\n  )) %>% \n  # Get rid of anything before 2016\n  filter(grant_year > 2015) %>% \n  # Make a categorical version of the year column\n  mutate(grant_year_category = factor(grant_year))\n```\n:::\n\n\n## Histograms\n\nFirst let's look at the distribution of grant amounts with a histogram. Map `grant_amount` to the x-axis and don't map anything to the y-axis, since `geom_histogram()` will calculate the y-axis values for us:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = bbc, mapping = aes(x = grant_amount)) +\n  geom_histogram()\n## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/hist-basic-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nNotice that ggplot warns you about bin widths. By default it will divide the data into 30 equally spaced bins, which will most likely not be the best for your data. You should *always* set your own bin width to something more appropriate. There are no rules for correct bin widths. Just don't have them be too wide:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = bbc, mapping = aes(x = grant_amount)) +\n  geom_histogram(binwidth = 100000)\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/hist-wide-bin-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nOr too small:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = bbc, mapping = aes(x = grant_amount)) +\n  geom_histogram(binwidth = 500)\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/hist-tiny-bins-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nÂ£10,000 seems to fit well. It's often helpful to add a white border to the histogram bars, too:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = bbc, mapping = aes(x = grant_amount)) +\n  geom_histogram(binwidth = 10000, color = \"white\")\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/hist-good-bins-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nWe can map other variables onto the plot, like mapping `grant_year_category` to the fill aesthetic:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_amount, fill = grant_year_category)) +\n  geom_histogram(binwidth = 10000, color = \"white\")\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/hist-bad-fill-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nThat gets really hard to interpret though, so we can facet by year with `facet_wrap()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_amount, fill = grant_year_category)) +\n  geom_histogram(binwidth = 10000, color = \"white\") +\n  facet_wrap(vars(grant_year))\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/hist-facet-fill-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nNeat!\n\n## Points\n\nNext let's look at the data using points, mapping year to the x-axis and grant amount to the y-axis:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_year_category, y = grant_amount)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/points-initial-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nWe have some serious overplotting here, with dots so thick that it looks like lines. We can fix this a couple different ways. First, we can make the points semi-transparent using `alpha`, which ranges from 0 (completely invisible) to 1 (completely solid).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_year_category, y = grant_amount)) +\n  geom_point(alpha = 0.1)\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/points-alpha-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nWe can also randomly space the points to spread them out using `position_jitter()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_year_category, y = grant_amount)) +\n  geom_point(position = position_jitter())\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/points-jitter-default-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nOne issue with this, though, is that the points are jittered along the x-axis (which is fine, since they're all within the same year) *and* the y-axis (which is bad, since the amounts are actual numbers). We can tell ggplot to only jitter in one direction by specifying the `height` argumentâ€”we don't want any up-and-down jittering:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_year_category, y = grant_amount)) +\n  geom_point(position = position_jitter(height = 0))\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/points-jitter-horizontal-only-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nThere are some weird clusters around Â£30,000 and below. Let's map `grant_program` to the color aesthetic, which has two categoriesâ€”regular grants and small grantsâ€”and see if that helps explain why:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_year_category, y = grant_amount, color = grant_program)) +\n  geom_point(position = position_jitter(height = 0))\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/points-jitter-color-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nIt does! We appear to have two different distributions of grants: small grants have a limit of Â£30,000, while regular grants have a much higher average amount.\n\n## Boxplots\n\nWe can add summary information to the plot by only changing the `geom` we're using. Switch from `geom_point()` to `geom_boxplot()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc, aes(x = grant_year_category, y = grant_amount, color = grant_program)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/boxplot-1.png){fig-align='center' width=576}\n:::\n:::\n\n\n## Summaries\n\nWe can also make smaller summarized datasets with {dplyr} functions like `group_by()` and `summarize()` and plot those. First let's look at grant totals, averages, and counts over time:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbc_by_year <- bbc %>% \n  group_by(grant_year) %>%  # Make invisible subgroups for each year\n  summarize(total = sum(grant_amount),  # Find the total awarded in each group\n            avg = mean(grant_amount),  # Find the average awarded in each group\n            number = n())  # n() is a special function that shows the number of rows in each group\n\n# Look at our summarized data\nbbc_by_year\n## # A tibble: 4 Ã— 4\n##   grant_year    total    avg number\n##        <dbl>    <dbl>  <dbl>  <int>\n## 1       2016 17290488 78238.    221\n## 2       2017 62394278 59765.   1044\n## 3       2018 61349392 60205.   1019\n## 4       2019 41388816 61136.    677\n```\n:::\n\n\nBecause we used `summarize()`, R shrank our data down significantly. We now only have a row for each of the subgroups we made: one for each year. We can plot this smaller data. We'll use `geom_col()` for now (but in the next session you'll learn why this is actually bad for averages!)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Plot our summarized data\nggplot(bbc_by_year, aes(x = grant_year, y = avg)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-summaries-1.png){fig-align='center' width=576}\n:::\n\n```{.r .cell-code}\nggplot(bbc_by_year, aes(x = grant_year, y = total)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-summaries-2.png){fig-align='center' width=576}\n:::\n\n```{.r .cell-code}\nggplot(bbc_by_year, aes(x = grant_year, y = number)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-summaries-3.png){fig-align='center' width=576}\n:::\n:::\n\n\nBased on these charts, it looks like 2016 saw the largest average grant amount. In all other years, grants averaged around Â£60,000, but in 2016 it jumped up to Â£80,000. If we look at total grants, though, we can see that there were far fewer grants awarded in 2016â€”only 221! 2017 and 2018 were much bigger years with far more money awarded.\n\nWe can also use multiple aesthetics to reveal more information from the data. First we'll make a new small summary dataset and group by both year and grant program. With those groups, we'll again calculate the total, average, and number.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbc_year_size <- bbc %>% \n  group_by(grant_year, grant_program) %>% \n  summarize(total = sum(grant_amount),\n            avg = mean(grant_amount),\n            number = n())\n\nbbc_year_size\n## # A tibble: 8 Ã— 5\n## # Groups:   grant_year [4]\n##   grant_year grant_program    total    avg number\n##        <dbl> <chr>            <dbl>  <dbl>  <int>\n## 1       2016 Main Grants   16405586 86345.    190\n## 2       2016 Small Grants    884902 28545.     31\n## 3       2017 Main Grants   48502923 90154.    538\n## 4       2017 Small Grants  13891355 27453.    506\n## 5       2018 Main Grants   47347789 95652.    495\n## 6       2018 Small Grants  14001603 26721.    524\n## 7       2019 Main Grants   33019492 96267.    343\n## 8       2019 Small Grants   8369324 25058.    334\n```\n:::\n\n\nNext we'll plot the data, mapping the `grant_program` column to the `fill` aesthetic:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc_year_size, aes(x = grant_year, y = total, fill = grant_program)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-size-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nBy default, ggplot will stack the different fill colors within the same bar, but this makes it a little hard to make comparisons. While we can see that the average small grant amount was a little bigger in 2017 than in 2019, it's harder to compare average main grant amount, since the bottoms of those sections don't align.\n\nTo fix this, we can use `position_dodge()` to tell the columns to fit side-by-side:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc_year_size, aes(x = grant_year, y = total, fill = grant_program)) +\n  geom_col(position = position_dodge())\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-size-dodge-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nInstead of dodging, we can also facet by `grant_program` to separate the bars:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc_year_size, aes(x = grant_year, y = total, fill = grant_program)) +\n  geom_col() +\n  facet_wrap(vars(grant_program))\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-size-facet-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nWe can put these in one column if we want:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc_year_size, aes(x = grant_year, y = total, fill = grant_program)) +\n  geom_col() +\n  facet_wrap(vars(grant_program), ncol = 1)\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-size-col-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nFinally, we can include even more variables! We have a lot of aesthetics we can work with (`size`, `alpha`, `color`, `fill`, `linetype`, etc.), as well as facets, so let's add one more to show the duration of the awarded grant.\n\nFirst we'll make another smaller summarized dataset, grouping by year, program, and duration and summarizing the total, average, and number of awards.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbc_year_size_duration <- bbc %>% \n  group_by(grant_year, grant_program, grant_duration_text) %>% \n  summarize(total = sum(grant_amount),\n            avg = mean(grant_amount),\n            number = n())\n\nbbc_year_size_duration\n## # A tibble: 21 Ã— 6\n## # Groups:   grant_year, grant_program [8]\n##    grant_year grant_program grant_duration_text    total    avg number\n##         <dbl> <chr>         <chr>                  <dbl>  <dbl>  <int>\n##  1       2016 Main Grants   2 years                97355 48678.      2\n##  2       2016 Main Grants   3 years             16308231 86746.    188\n##  3       2016 Small Grants  3 years               884902 28545.     31\n##  4       2017 Main Grants   1 year                 59586 29793       2\n##  5       2017 Main Grants   2 years               825732 82573.     10\n##  6       2017 Main Grants   3 years             47617605 90528.    526\n##  7       2017 Small Grants  1 year                 10000 10000       1\n##  8       2017 Small Grants  2 years               245227 18864.     13\n##  9       2017 Small Grants  3 years             13636128 27716.    492\n## 10       2018 Main Grants   1 year                118134 59067       2\n## # â„¹ 11 more rows\n```\n:::\n\n\nNext, we'll fill by grant program and facet by duration and show the total number of grants awarded\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(bbc_year_size_duration, aes(x = grant_year, y = number, fill = grant_program)) +\n  geom_col(position = position_dodge(preserve = \"single\")) +\n  facet_wrap(vars(grant_duration_text), ncol = 1)\n```\n\n::: {.cell-output-display}\n![](03-example_files/figure-html/plot-year-size-duration-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nThe vast majority of BBC Children in Need's grants last for 3 years. Super neat.\n",
    "supporting": [
      "03-example_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}